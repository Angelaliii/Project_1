# 教室預約系統滑動選取功能說明

本文件整理了教室預約系統中所有與滑動選取（Drag Selection）相關的程式碼和功能說明。滑動選取功能允許使用者透過滑鼠拖曳的方式快速選擇連續的時間區段，提高使用者操作效率。

## 目錄

1. [功能概述](#功能概述)
2. [舊版預約頁面滑動選取](#舊版預約頁面滑動選取)
3. [新版預約頁面滑動選取](#新版預約頁面滑動選取)
4. [核心實作原理](#核心實作原理)
5. [資料結構與處理](#資料結構與處理)
6. [後端處理流程](#後端處理流程)

## 功能概述

滑動選取功能實現了以下能力：

- **舊版預約頁面**：使用者可以在單一教室的時間表格中拖曳選擇多個時段，支援新增和取消選取
- **新版預約頁面**：使用者可以在多個教室的時間表格中拖曳選擇同一教室的多個時段
- **自動分組**：系統會自動將連續選取的時段組合為單一預約
- **即時視覺反饋**：選取過程中提供即時的視覺反饋
- **資料處理**：自動更新表單數據，為提交做準備

## 舊版預約頁面滑動選取

舊版預約頁面（booking.js）中的滑動選取功能實現了單一教室的多時段選擇。

### 主要變數

```javascript
let isDragging = false;
let dragMode = "select"; // 'select' 或 'deselect'
let selectedHours = [];
```

### 主要事件監聽器

```javascript
// 拖曳開始
cell.addEventListener("mousedown", function (e) {
  isDragging = true;
  const hour = parseInt(this.dataset.hour);
  if (isNaN(hour)) return;

  dragMode = selectedHours.includes(hour) ? "deselect" : "select";
  applyDragAction(this);
  updateSelectedTimes();
  e.preventDefault();
});

// 拖曳過程
cell.addEventListener("mouseover", function () {
  if (isDragging) {
    applyDragAction(this);
    updateSelectedTimes();
    console.log("拖曳中: 選取的時間", selectedHours);
  }
});

// 拖曳結束
document.addEventListener("mouseup", function () {
  if (isDragging) {
    isDragging = false;
    // 確保更新表單顯示狀態
    bookingForm.style.display = selectedHours.length > 0 ? "block" : "none";
    console.log("拖曳結束: 最終選取的時間", selectedHours);
  }
});
```

### 拖曳動作處理

```javascript
function applyDragAction(cell) {
  const hour = parseInt(cell.dataset.hour);
  if (isNaN(hour)) return;

  const isSelected = selectedHours.includes(hour);

  if (dragMode === "select" && !isSelected) {
    cell.classList.add("selected");
    selectedHours.push(hour);
    console.log("拖曳選取時間:", hour);
  } else if (dragMode === "deselect" && isSelected) {
    cell.classList.remove("selected");
    selectedHours = selectedHours.filter((h) => h !== hour);
    console.log("拖曳取消選取時間:", hour);
  }

  selectedHours.sort((a, b) => a - b);
  selectedHoursInput.value = JSON.stringify(selectedHours);
}
```

### 選取時間顯示更新

```javascript
function updateSelectedTimes() {
  console.log("更新時間顯示，當前選取:", selectedHours);

  if (selectedHours.length === 0) {
    selectedTimesDisplay.innerText = "尚未選擇時間，請在上方時間表格拖曳選擇";
    return;
  }

  // 對選擇的時間排序
  selectedHours.sort((a, b) => a - b);
  console.log("排序後的時間:", selectedHours);

  // 找出連續的時間段分組
  let timeRanges = [];
  let currentGroup = [selectedHours[0]];

  for (let i = 1; i < selectedHours.length; i++) {
    // 如果當前時間和前一個時間連續，加入同一組
    if (selectedHours[i] === selectedHours[i - 1] + 1) {
      currentGroup.push(selectedHours[i]);
    } else {
      // 不連續，結束當前組並開始新的一組
      const startHour = currentGroup[0];
      const endHour = currentGroup[currentGroup.length - 1];
      timeRanges.push(`${startHour}:00 - ${endHour + 1}:00`);
      currentGroup = [selectedHours[i]];
    }
  }

  // 處理最後一組
  if (currentGroup.length > 0) {
    const startHour = currentGroup[0];
    const endHour = currentGroup[currentGroup.length - 1];
    timeRanges.push(`${startHour}:00 - ${endHour + 1}:00`);
  }

  // 顯示所有時間段
  const displayHTML =
    "<strong>已選擇時間段:</strong><br>" +
    timeRanges
      .map((range, index) => `時段 ${index + 1}: ${range}`)
      .join("<br>");

  selectedTimesDisplay.innerHTML = displayHTML;
}
```

## 新版預約頁面滑動選取

新版預約頁面（new-booking.js）中的滑動選取功能針對多教室進行了優化，限制只能在同一教室的時間格拖曳選取。

### 主要變數

```javascript
let selectedSlots = [];
let isDragging = false;
let dragStartCell = null;
```

### 主要事件監聽器

```javascript
// 開始拖曳
slot.addEventListener("mousedown", function (e) {
  isDragging = true;
  dragStartCell = this;
  // 儲存當前教室 ID，以確保只能在同一行內選取
  dragStartCell.classroomId = parseInt(this.dataset.classroomId);
  e.preventDefault();
});

// 拖曳經過
slot.addEventListener("mouseenter", function (e) {
  if (isDragging) {
    // 檢查是否與起始拖曳在同一教室
    const currentClassroomId = parseInt(this.dataset.classroomId);

    // 確保獲取到有效的教室ID並且是同一教室
    if (
      dragStartCell.classroomId &&
      currentClassroomId &&
      dragStartCell.classroomId === currentClassroomId
    ) {
      // 模擬點擊效果
      const event = new Event("click");
      this.dispatchEvent(event);
    }
  }
});

// 停止拖曳
document.addEventListener("mouseup", function () {
  if (isDragging) {
    isDragging = false;
    dragStartCell = null;
  }
});
```

### 尋找連續時間段

```javascript
function findTimeRanges(hours) {
  if (hours.length === 0) return [];

  // 確保時間是排序的
  hours.sort((a, b) => a - b);

  const ranges = [];
  let start = hours[0];
  let end = hours[0];

  for (let i = 1; i < hours.length; i++) {
    if (hours[i] === end + 1) {
      end = hours[i];
    } else {
      ranges.push({ start, end: end + 1 });
      start = hours[i];
      end = hours[i];
    }
  }

  ranges.push({ start, end: end + 1 });
  return ranges;
}
```

## 核心實作原理

滑動選取功能的核心實現原理包括：

1. **狀態跟踪**：

   - `isDragging`：標記是否正在拖曳中
   - `dragMode` / `dragStartCell`：標記拖曳的初始狀態和起點

2. **事件處理**：

   - `mousedown`：開始拖曳
   - `mouseover` / `mouseenter`：拖曳過程中處理經過的格子
   - `mouseup`：結束拖曳

3. **數據同步**：

   - 將選取結果同步到隱藏輸入欄位，方便表單提交
   - 自動排序和分組連續時間段

4. **視覺反饋**：
   - 添加/移除 CSS 類以提供即時視覺反饋
   - 顯示已選時段的摘要信息

## 資料結構與處理

### 舊版預約頁面資料結構

```javascript
// 簡單數組存儲小時數
let selectedHours = [9, 10, 11, 13]; // 例如 9:00, 10:00, 11:00, 13:00
```

### 新版預約頁面資料結構

```javascript
// 複雜對象數組存儲教室和時間
let selectedSlots = [
  {
    classroomId: 1,
    hour: 9,
    classroomName: "教室A",
    classroomLocation: "主樓",
  },
  {
    classroomId: 1,
    hour: 10,
    classroomName: "教室A",
    classroomLocation: "主樓",
  },
];
```

### 分組邏輯

為了用戶體驗，系統會自動將連續的時間段分組顯示，例如：

```
時段 1: 9:00 - 12:00
時段 2: 13:00 - 14:00
```

## 後端處理流程

滑動選取的資料提交後，在後端 `process_booking_drag.php` 中進行處理：

1. **數據解析**：將 JSON 格式的選定時段解析為 PHP 數組
2. **分組處理**：按照教室 ID 將選定的時段分組
3. **連續時段識別**：識別每個教室中連續的時間段
4. **資料庫交易**：使用交易確保所有插入操作的一致性
5. **預約創建**：為每個連續時間段創建一個預約記錄
6. **時段記錄**：為每個選定的小時創建時段記錄
7. **反饋處理**：向用戶提供操作成功或失敗的反饋

核心處理邏輯如下：

```php
// 找出連續的時間段
$timeGroups = [];
$currentGroup = [$hours[0]];

for ($i = 1; $i < count($hours); $i++) {
    if ($hours[$i] == $hours[$i-1] + 1) {
        // 時間連續，添加到當前組
        $currentGroup[] = $hours[$i];
    } else {
        // 時間不連續，結束當前組，開始新的一組
        $timeGroups[] = $currentGroup;
        $currentGroup = [$hours[$i]];
    }
}

// 添加最後一組
$timeGroups[] = $currentGroup;

// 處理每個連續時間段為一個預約
foreach ($timeGroups as $group) {
    // 計算開始和結束時間
    $startHour = reset($group);
    $endHour = end($group) + 1; // 結束時間為最後一個小時 + 1

    // 建立 datetime 格式的開始和結束時間
    $startDatetime = "$bookingDate $startHour:00:00";
    $endDatetime = "$bookingDate $endHour:00:00";

    // 創建新預約
    // ...
}
```

## 結論

滑動選取功能極大地提高了用戶的操作效率，使得選取多個連續時段變得輕鬆簡單。該功能的實現結合了前端互動體驗和後端資料處理的優化，是系統中一個重要的使用者體驗設計。

此功能的實現方式可以作為其他需要多選項目的系統參考，特別是需要選取連續時間或日期的系統。
